# crossPageTable - è·¨é¡µè¡¨æ ¼å¤„ç†æ¨¡å—

## æ¦‚è¿°

è¯¥ç›®å½•åŒ…å«è·¨é¡µè¡¨æ ¼å¤„ç†çš„æ‰€æœ‰åŠŸèƒ½ï¼Œä»åŸæ¥çš„ `cross_page_merger.py`ï¼ˆ2036è¡Œï¼‰ä¸­é€æ­¥æ‹†åˆ†è€Œæ¥ã€‚

---

## é‡æ„è¿›åº¦

### âœ… å·²å®Œæˆ

- [x] **`cell_merger.py`** - å•å…ƒæ ¼åˆå¹¶å™¨ï¼ˆåŸºäºè§„åˆ™ï¼‰
  - åŠŸèƒ½ï¼šæ£€æµ‹å¹¶åˆå¹¶è¢«åˆ†é¡µç¬¦æˆªæ–­çš„å•å…ƒæ ¼å†…å®¹
  - è¡Œæ•°ï¼š~370 è¡Œ
  - æ—¥æœŸï¼š2025-10-29
  - å‘åå…¼å®¹ï¼šä¿ç•™äº†æ¨¡å—çº§å‡½æ•° `_detect_split_cells()`, `_merge_split_cells()`, `_cell_has_horizontal_line()`

- [x] **`cell_classifier.py`** - å•å…ƒæ ¼æ™ºèƒ½åˆ†ç±»å™¨ï¼ˆåŸºäºAIï¼‰
  - åŠŸèƒ½ï¼šä½¿ç”¨ AI æ¨¡å‹åˆ¤æ–­è·¨é¡µå•å…ƒæ ¼/è¡Œæ˜¯å¦åº”è¯¥åˆå¹¶
  - è¡Œæ•°ï¼š~630 è¡Œ
  - æ—¥æœŸï¼š2025-10-29
  - ç‰¹æ€§ï¼š
    - åŸºäº Qwen3-32B æ¨¡å‹è¿›è¡Œæ™ºèƒ½åˆ¤æ–­
    - ä½æ¸©åº¦æ¨ç†ï¼ˆtemperature=0.1ï¼‰ä¿è¯ç¡®å®šæ€§
    - æ”¯æŒ**å•å…ƒæ ¼çº§åˆ«åˆ¤æ–­**ï¼ˆtdï¼‰å’Œ**è¡Œçº§åˆ«åˆ¤æ–­**ï¼ˆtrï¼‰
    - æ”¯æŒå•ä¸ª/æ‰¹é‡åˆ†ç±»
    - æ™ºèƒ½å­—ç¬¦æˆªå–ï¼ˆå–æœ€å/æœ€å‰ n ä¸ªå­—ç¬¦ï¼‰
    - ç›´æ¥åˆ†æ raw.json ä¸­çš„ hint æ•°æ®
    - è¿”å› JSON æ ¼å¼ï¼ˆshould_mergeã€confidenceã€reasonï¼‰

### ğŸ”œ å¾…æ‹†åˆ†

æŒ‰ä¼˜å…ˆçº§æ’åºï¼š

1. **`models.py`** - æ•°æ®ç»“æ„
   - `TableFingerprint` - è¡¨æ ¼æŒ‡çº¹æ•°æ®ç±»
   - `MergeCandidate` - åˆå¹¶å€™é€‰æ•°æ®ç±»
   - é¢„è®¡è¡Œæ•°ï¼š~50 è¡Œ

2. **`utils.py`** - å·¥å…·å‡½æ•°
   - `calculate_jaccard_similarity()` - Jaccardç›¸ä¼¼åº¦
   - `normalize_to_page_width()` - åæ ‡å½’ä¸€åŒ–
   - `hash_col_paths()` - åˆ—è·¯å¾„å“ˆå¸Œ
   - é¢„è®¡è¡Œæ•°ï¼š~80 è¡Œ

3. **`fingerprint.py`** - æŒ‡çº¹ç”Ÿæˆå™¨
   - `FingerprintGenerator` ç±»
   - åŠŸèƒ½ï¼šä¸ºè¡¨æ ¼ç”Ÿæˆå‡ ä½•/ç»“æ„/è§†è§‰ç‰¹å¾æŒ‡çº¹
   - é¢„è®¡è¡Œæ•°ï¼š~250 è¡Œ

4. **`scoring.py`** - å¾—åˆ†è®¡ç®—å™¨
   - `TableScorer` ç±»
   - åŠŸèƒ½ï¼šè®¡ç®—è¡¨æ ¼åŒ¹é…å¾—åˆ†ï¼ˆå‡ ä½•ã€ç»“æ„ã€è§†è§‰ï¼‰
   - é¢„è®¡è¡Œæ•°ï¼š~250 è¡Œ

5. **`header_handler.py`** - è¡¨å¤´å¤„ç†å™¨
   - `HeaderHandler` ç±»
   - åŠŸèƒ½ï¼šè¡¨å¤´æ¢å¤ã€å»é‡ã€å»¶è¿Ÿè¯†åˆ«
   - é¢„è®¡è¡Œæ•°ï¼š~300 è¡Œ

6. **`continuation_hint.py`** - ç»­é¡µæç¤ºç”Ÿæˆå™¨
   - `ContinuationHintBuilder` ç±»
   - åŠŸèƒ½ï¼šç”Ÿæˆç»­é¡µhintsï¼Œè¡¥é½ç¼ºå¤±åˆ—
   - é¢„è®¡è¡Œæ•°ï¼š~400 è¡Œ

7. **`chain_finder.py`** - åˆå¹¶é“¾è¯†åˆ«å™¨
   - `ChainFinder` ç±»
   - åŠŸèƒ½ï¼šè¯†åˆ«éœ€è¦åˆå¹¶çš„è¡¨æ ¼é“¾ï¼Œæ£€æŸ¥æ­£æ–‡éš”æ–­
   - é¢„è®¡è¡Œæ•°ï¼š~300 è¡Œ

8. **`table_merger.py`** - è¡¨æ ¼åˆå¹¶å™¨
   - `TableMerger` ç±»
   - åŠŸèƒ½ï¼šåˆå¹¶è¡¨æ®µï¼Œæ‹¼æ¥æ•°æ®è¡Œ
   - é¢„è®¡è¡Œæ•°ï¼š~200 è¡Œ

9. **`merger.py`** - ä¸»åè°ƒç±»
   - `CrossPageTableMerger` ç±»ï¼ˆé‡æ„ç‰ˆï¼‰
   - åŠŸèƒ½ï¼šç»„åˆæ‰€æœ‰å­æ¨¡å—ï¼Œæä¾›ç»Ÿä¸€å…¥å£
   - é¢„è®¡è¡Œæ•°ï¼š~150 è¡Œ

---

## é‡æ„ç­–ç•¥

### æ¸è¿›å¼é‡æ„

é‡‡ç”¨"æŒ‰éœ€æ‹†åˆ†"ç­–ç•¥ï¼š
- **ä¸ä¸€æ¬¡æ€§é‡æ„æ‰€æœ‰ä»£ç **ï¼ˆé¿å…å¤§è§„æ¨¡æ”¹åŠ¨é£é™©ï¼‰
- **åœ¨éœ€è¦ä¿®æ”¹æŸä¸ªåŠŸèƒ½æ—¶ï¼Œä¼˜å…ˆæ‹†åˆ†è¯¥æ¨¡å—**
- **ä¿æŒå‘åå…¼å®¹**ï¼Œé¿å…å½±å“ç°æœ‰ä»£ç 

### æ‹†åˆ†åŸåˆ™

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸ
2. **ä½è€¦åˆ**ï¼šæ¨¡å—é—´ä¾èµ–å°½é‡å°‘
3. **é«˜å†…èš**ï¼šç›¸å…³åŠŸèƒ½èšåˆåœ¨ä¸€èµ·
4. **å‘åå…¼å®¹**ï¼šä¿ç•™æ—§çš„å‡½æ•°ç­¾åï¼Œæ ‡è®°ä¸º deprecated

---

## å½“å‰æ¶æ„

### åŸå§‹æ–‡ä»¶ï¼ˆæœªæ‹†åˆ†éƒ¨åˆ†ï¼‰
- `cross_page_merger.py` - ä¸»æ–‡ä»¶ï¼ˆ1666è¡Œå‰©ä½™ï¼‰
  - ä»åŒ…å«ï¼šæŒ‡çº¹ç”Ÿæˆã€å¾—åˆ†è®¡ç®—ã€åˆå¹¶é“¾è¯†åˆ«ã€è¡¨æ ¼åˆå¹¶ã€è¡¨å¤´å¤„ç†ã€ç»­é¡µæç¤ºç­‰

### å·²æ‹†åˆ†æ¨¡å—
- `crossPageTable/cell_merger.py` - å•å…ƒæ ¼åˆå¹¶å™¨ï¼ˆ370è¡Œï¼ŒåŸºäºè§„åˆ™ï¼‰
- `crossPageTable/cell_classifier.py` - å•å…ƒæ ¼æ™ºèƒ½åˆ†ç±»å™¨ï¼ˆ400è¡Œï¼ŒåŸºäºAIï¼‰

### å¯¼å…¥å…³ç³»
```
cross_page_merger.py
    â†“ å¯¼å…¥
crossPageTable.cell_merger
    - _detect_split_cells()
    - _merge_split_cells()
    - _cell_has_horizontal_line()

pdf_content_extractor.py æˆ–å…¶ä»–æ¨¡å—
    â†“ å¯é€‰å¯¼å…¥
crossPageTable.cell_classifier
    - CrossPageCellClassifier
```

---

## ç›®æ ‡æ¶æ„ï¼ˆå®Œæ•´æ‹†åˆ†åï¼‰

```
crossPageTable/
â”œâ”€â”€ __init__.py              # å¯¼å‡ºæ‰€æœ‰å…¬å…±æ¥å£
â”œâ”€â”€ README.md                # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ models.py                # æ•°æ®ç»“æ„
â”œâ”€â”€ utils.py                 # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ fingerprint.py           # æŒ‡çº¹ç”Ÿæˆå™¨
â”œâ”€â”€ scoring.py               # å¾—åˆ†è®¡ç®—å™¨
â”œâ”€â”€ chain_finder.py          # åˆå¹¶é“¾è¯†åˆ«å™¨
â”œâ”€â”€ table_merger.py          # è¡¨æ ¼åˆå¹¶å™¨
â”œâ”€â”€ header_handler.py        # è¡¨å¤´å¤„ç†å™¨
â”œâ”€â”€ cell_merger.py           # å•å…ƒæ ¼åˆå¹¶å™¨ï¼ˆåŸºäºè§„åˆ™ï¼‰ âœ…
â”œâ”€â”€ cell_classifier.py       # å•å…ƒæ ¼æ™ºèƒ½åˆ†ç±»å™¨ï¼ˆåŸºäºAIï¼‰ âœ…
â”œâ”€â”€ continuation_hint.py     # ç»­é¡µæç¤ºç”Ÿæˆå™¨
â”‚
â””â”€â”€ merger.py                # ä¸»åè°ƒç±»
```

---

## ä½¿ç”¨ç¤ºä¾‹

### å½“å‰ä½¿ç”¨æ–¹å¼ï¼ˆæœªå®Œå…¨æ‹†åˆ†ï¼‰

```python
from cross_page_merger import CrossPageTableMerger

# åˆ›å»ºåˆå¹¶å™¨ï¼ˆenable_cell_merge æ§åˆ¶å•å…ƒæ ¼åˆå¹¶ï¼‰
merger = CrossPageTableMerger(
    score_threshold=0.70,
    enable_cell_merge=False  # é»˜è®¤å…³é—­
)

# æ‰§è¡Œåˆå¹¶
merged_tables = merger.merge_all_tables(
    tables,
    page_widths,
    page_drawings,
    layout_index
)
```

### æ–°æ¨¡å—ä½¿ç”¨æ–¹å¼ï¼ˆå·²å®ç°ï¼‰

```python
from crossPageTable import CellMerger, CrossPageCellClassifier

# æ–¹å¼1ï¼šåŸºäºè§„åˆ™çš„å•å…ƒæ ¼åˆå¹¶ï¼ˆé€‚ç”¨äºæ˜ç¡®çš„å‡ ä½•ç‰¹å¾ï¼‰
cell_merger = CellMerger(coverage_threshold=0.5)
split_indices = cell_merger.detect_split_cells(
    prev_last_row, next_first_row,
    prev_drawings, next_drawings
)
cell_merger.merge_split_cells(prev_row, next_row, split_indices)

# æ–¹å¼2ï¼šåŸºäºAIçš„æ™ºèƒ½åˆ¤æ–­ï¼ˆé€‚ç”¨äºè¯­ä¹‰åˆ¤æ–­ï¼‰
classifier = CrossPageCellClassifier()

# å•ä¸ªå•å…ƒæ ¼å¯¹åˆ¤æ–­
result = classifier.classify_cell_pair(
    prev_cell_content="æ ¹æ®æŠ•æ ‡äººæä¾›çš„é¡¹ç›®æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ€»ä½“æ¶æ„è®¾è®¡ã€ä¸šåŠ¡æ¶æ„è®¾è®¡ã€æ•°æ®æ¶æ„è®¾è®¡ã€æŠ€æœ¯æ¶æ„è®¾",
    next_cell_content="è®¡ã€ç½‘ç»œæ¶æ„è®¾è®¡ã€ä¸ç°æœ‰å›½åœŸç©ºé—´è§„åˆ’"ä¸€å¼ å›¾"å®æ–½ç›‘æµ‹ç³»ç»ŸåŠç›¸å…³ç³»ç»Ÿå¯¹æ¥æ–¹æ¡ˆç­‰æ–¹é¢è¿›è¡Œç»¼åˆè¯„å®¡ã€‚"
)
print(f"åº”è¯¥åˆå¹¶: {result['should_merge']}, ç½®ä¿¡åº¦: {result['confidence']}")

# æ‰¹é‡åˆ†æ raw.json ä¸­çš„ hint æ•°æ®ï¼ˆå•å…ƒæ ¼çº§åˆ«ï¼‰
results = classifier.analyze_raw_json_with_hints(raw_json_data, hints_by_page)
print(f"åˆ†æäº† {results['total_cell_pairs']} ä¸ªå•å…ƒæ ¼å¯¹")
print(f"åº”è¯¥åˆå¹¶: {results['summary']['should_merge']} ä¸ª")
print(f"ä¸åº”åˆå¹¶: {results['summary']['should_not_merge']} ä¸ª")

# æ–¹å¼3ï¼šè¡Œçº§åˆ«åˆ¤æ–­ï¼ˆæ¨èç”¨äºè·¨é¡µè¡¨æ ¼è¯†åˆ«ï¼‰
# å‡†å¤‡è¡Œå¯¹æ•°æ®
row_pairs = [
    {
        "prev_row": {
            "ç¬¬0åˆ—": "æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡...",
            "ç¬¬1åˆ—": "5åˆ†",
            "ç¬¬2åˆ—": "ä¼˜ç§€"
        },
        "next_row": {
            "ç¬¬0åˆ—": "...åç»­å†…å®¹",
            "ç¬¬1åˆ—": "",
            "ç¬¬2åˆ—": ""
        },
        "context": {
            "prev_page": 1,
            "next_page": 2,
            "hint_score": 0.95
        }
    }
]

# æ‰¹é‡åˆ¤æ–­ï¼ˆè‡ªåŠ¨æˆªå–æœ€å/æœ€å‰nä¸ªå­—ç¬¦ï¼‰
row_results = classifier.classify_row_pairs_batch(row_pairs)
for result in row_results:
    print(f"åº”è¯¥åˆå¹¶: {result['should_merge']}, ç½®ä¿¡åº¦: {result['confidence']}")
```

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

æ¯ä¸ªæ‹†åˆ†çš„æ¨¡å—éƒ½åº”è¯¥æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•ï¼š

```
tests/
â””â”€â”€ crossPageTable/
    â”œâ”€â”€ test_cell_merger.py           # âœ… å·²åˆ›å»ºæ¨¡å—ï¼Œå¾…æ·»åŠ æµ‹è¯•
    â”œâ”€â”€ test_cell_classifier.py       # âœ… å·²åˆ›å»ºæ¨¡å—ï¼Œå¾…æ·»åŠ æµ‹è¯•
    â”œâ”€â”€ test_fingerprint.py
    â”œâ”€â”€ test_scoring.py
    â”œâ”€â”€ test_chain_finder.py
    â””â”€â”€ ...
```

**æµ‹è¯•è¯´æ˜**ï¼š
- `cell_classifier.py` åŒ…å«å†…ç½®çš„ `main()` æµ‹è¯•å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼š
  ```bash
  python app/utils/unTaggedPDF/crossPageTable/cell_classifier.py
  ```

### é›†æˆæµ‹è¯•

ç¡®ä¿é‡æ„ååŠŸèƒ½ä¸åŸæ¥å®Œå…¨ä¸€è‡´ï¼š
- ä½¿ç”¨ç›¸åŒçš„æµ‹è¯•PDF
- å¯¹æ¯”é‡æ„å‰åçš„è¾“å‡ºç»“æœ
- è¡Œæ•°ã€åˆ—æ•°ã€å†…å®¹å®Œå…¨åŒ¹é…

---

## è´¡çŒ®æŒ‡å—

### å¦‚ä½•æ‹†åˆ†ä¸€ä¸ªæ–°æ¨¡å—ï¼Ÿ

1. **è¯†åˆ«åŠŸèƒ½è¾¹ç•Œ**
   - æ‰¾åˆ°ç›¸å…³çš„æ–¹æ³•/å‡½æ•°
   - ç¡®å®šä¾èµ–å…³ç³»

2. **åˆ›å»ºæ–°æ–‡ä»¶**
   - åœ¨ `crossPageTable/` ç›®å½•ä¸‹åˆ›å»ºæ–°æ¨¡å—
   - ç¼–å†™æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²

3. **è¿ç§»ä»£ç **
   - ä» `cross_page_merger.py` å¤åˆ¶ç›¸å…³ä»£ç 
   - å°è£…æˆç±»æˆ–å‡½æ•°
   - ä¿ç•™å‘åå…¼å®¹çš„æ¥å£

4. **æ›´æ–°å¯¼å…¥**
   - åœ¨ `__init__.py` ä¸­å¯¼å‡ºæ–°æ¨¡å—
   - æ›´æ–° `cross_page_merger.py` çš„å¯¼å…¥

5. **æµ‹è¯•**
   - è¿è¡ŒåŸæœ‰æµ‹è¯•ï¼Œç¡®ä¿åŠŸèƒ½ä¸å˜
   - æ·»åŠ æ–°æ¨¡å—çš„å•å…ƒæµ‹è¯•

6. **æ›´æ–°æ–‡æ¡£**
   - æ›´æ–°æœ¬ README.md
   - æ ‡è®°å·²å®Œæˆçš„æ¨¡å—

---

## æ³¨æ„äº‹é¡¹

### å‘åå…¼å®¹

- âš ï¸ **ä¸è¦åˆ é™¤**åŸæ¥çš„ `cross_page_merger.py` æ–‡ä»¶
- âš ï¸ **ä¿ç•™**æ‰€æœ‰å…¬å…±å‡½æ•°çš„ç­¾å
- âœ… **å¯ä»¥æ ‡è®°**ä¸º deprecatedï¼Œä½†ä¸èƒ½åˆ é™¤

### å¯¼å…¥è·¯å¾„

```python
# âœ… æ¨èï¼šä»æ–°æ¨¡å—å¯¼å…¥
from crossPageTable import CellMerger

# âœ… å…¼å®¹ï¼šä»æ—§æ–‡ä»¶å¯¼å…¥ï¼ˆå†…éƒ¨é‡å®šå‘åˆ°æ–°æ¨¡å—ï¼‰
from cross_page_merger import _detect_split_cells
```

---

## é‡æ„æ”¶ç›Š

### ä»£ç è´¨é‡
- âœ… æ–‡ä»¶å¤§å°ï¼šä» 2036 è¡Œæ‹†åˆ†ä¸ºå¤šä¸ª < 400 è¡Œçš„æ¨¡å—
- âœ… å¯è¯»æ€§ï¼šèŒè´£æ¸…æ™°ï¼Œæ˜“äºç†è§£
- âœ… å¯ç»´æŠ¤æ€§ï¼šä¿®æ”¹æŸä¸ªåŠŸèƒ½åªéœ€ä¿®æ”¹å¯¹åº”æ¨¡å—

### å¼€å‘æ•ˆç‡
- âœ… å¯æµ‹è¯•æ€§ï¼šæ¯ä¸ªæ¨¡å—å¯ç‹¬ç«‹æµ‹è¯•
- âœ… å¯æ‰©å±•æ€§ï¼šæ·»åŠ æ–°åŠŸèƒ½æ— éœ€ä¿®æ”¹ä¸»æ–‡ä»¶
- âœ… åä½œå‹å¥½ï¼šå¤šäººå¯å¹¶è¡Œå¼€å‘ä¸åŒæ¨¡å—

---

## æ›´æ–°æ—¥å¿—

### 2025-10-29ï¼ˆä¸‹åˆ2ï¼‰
- âœ… æ‰©å±• `cell_classifier.py` æ·»åŠ è¡Œçº§åˆ«åˆ¤æ–­åŠŸèƒ½ï¼ˆ630è¡Œï¼‰
- âœ… å®ç° `classify_row_pairs_batch()` æ–¹æ³•ï¼ˆæ‰¹é‡è¡Œåˆ¤æ–­ï¼‰
- âœ… å®ç° `_truncate_text()` æ–¹æ³•ï¼ˆå­—ç¬¦æˆªå–ï¼šæœ€å/æœ€å‰nä¸ªå­—ç¬¦ï¼‰
- âœ… æ·»åŠ è¡Œçº§åˆ« system_prompt
- âœ… åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_row_classifier.py`
- âœ… æ›´æ–° README.md æ–‡æ¡£

### 2025-10-29ï¼ˆä¸‹åˆ1ï¼‰
- âœ… åˆ›å»º `cell_classifier.py` æ¨¡å—ï¼ˆ400è¡Œï¼‰
- âœ… é›†æˆ Qwen3-32B æ¨¡å‹ç”¨äºæ™ºèƒ½åˆ¤æ–­
- âœ… å®ç° `analyze_raw_json_with_hints()` æ–¹æ³•
- âœ… æ›´æ–° `__init__.py` å¯¼å‡º `CrossPageCellClassifier`
- âœ… æ›´æ–° README.md æ–‡æ¡£

### 2025-10-29ï¼ˆä¸Šåˆï¼‰
- âœ… åˆ›å»º `crossPageTable/` ç›®å½•
- âœ… æ‹†åˆ† `cell_merger.py` æ¨¡å—ï¼ˆ370è¡Œï¼‰
- âœ… åˆ›å»º `__init__.py` å¯¼å‡ºæ¥å£
- âœ… åˆ›å»ºæœ¬ README.md æ–‡æ¡£

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **é›†æˆ AI åˆ†ç±»å™¨åˆ°ä¸»æµç¨‹**ï¼šåœ¨ raw.json ç”Ÿæˆåè°ƒç”¨ `CrossPageCellClassifier`
2. æ·»åŠ  `cell_merger.py` å’Œ `cell_classifier.py` çš„å•å…ƒæµ‹è¯•
3. æ‹†åˆ† `models.py`ï¼ˆæ•°æ®ç»“æ„ï¼‰
4. æ‹†åˆ† `utils.py`ï¼ˆå·¥å…·å‡½æ•°ï¼‰
5. é€æ­¥æ‹†åˆ†å…¶ä»–æ¨¡å—...

---

**é‡æ„åŸåˆ™**ï¼šç¨³æ­¥å‰è¿›ï¼Œä¿æŒç³»ç»Ÿç¨³å®šï¼ŒæŒ‰éœ€æ‹†åˆ†ã€‚